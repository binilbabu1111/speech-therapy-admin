<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | JisWorld Speech Therapy</title>
    <meta name="description"
        content="Log in or create an account at JisWorld Speech Therapy to manage appointments, track therapy progress, and connect with your child's therapist.">
    <link rel="stylesheet" href="style.css?v=login-v2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ‚îÄ‚îÄ Password Strength Bar ‚îÄ‚îÄ */
        .password-strength-wrap {
            margin-top: 8px;
        }

        .strength-bar-track {
            height: 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .strength-bar-fill {
            height: 100%;
            width: 0;
            border-radius: 3px;
            transition: width .35s ease, background .35s ease;
        }

        .strength-label {
            font-size: 0.75rem;
            margin-top: 4px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .strength-checklist {
            list-style: none;
            padding: 0;
            margin: 6px 0 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 12px;
            font-size: 0.72rem;
            color: #888;
        }

        .strength-checklist li::before {
            content: '‚óã ';
        }

        .strength-checklist li.met {
            color: #16a34a;
        }

        .strength-checklist li.met::before {
            content: '‚óè ';
        }

        /* ‚îÄ‚îÄ Field error styling ‚îÄ‚îÄ */
        .field-error {
            color: #dc2626;
            font-size: 0.78rem;
            margin-top: 3px;
            min-height: 1em;
            transition: opacity .2s;
        }

        .input-error {
            border-color: #dc2626 !important;
        }

        .input-valid {
            border-color: #16a34a !important;
        }

        /* ‚îÄ‚îÄ Parent / Guardian section ‚îÄ‚îÄ */
        #parentGuardianSection {
            border: 1px solid rgba(196, 164, 132, .3);
            border-radius: 12px;
            padding: 16px 18px;
            background: rgba(196, 164, 132, .04);
            margin-bottom: 16px;
        }

        #parentGuardianSection legend {
            font-weight: 700;
            font-size: 0.85rem;
            color: #C4A484;
            padding: 0 6px;
        }

        /* ‚îÄ‚îÄ Terms link ‚îÄ‚îÄ */
        .terms-link {
            color: #C4A484;
            text-decoration: underline;
            cursor: pointer;
        }

        .terms-link:hover {
            color: #a8855f;
        }

        /* ‚îÄ‚îÄ Forgot-password link ‚îÄ‚îÄ */
        /* Override: ensure .hidden beats .field-row { display:grid } */
        .hidden {
            display: none !important;
        }

        .forgot-link {
            display: block;
            text-align: right;
            font-size: 0.8rem;
            margin-top: 4px;
            color: #C4A484;
            text-decoration: none;
        }

        .forgot-link:hover {
            color: #a8855f;
            text-decoration: underline;
        }

        /* ‚îÄ‚îÄ Remember Me ‚îÄ‚îÄ */
        .remember-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.84rem;
            color: #555;
            margin-bottom: 8px;
        }

        .remember-row input[type=checkbox] {
            accent-color: #C4A484;
            width: 16px;
            height: 16px;
        }

        /* ‚îÄ‚îÄ Form width expansion for register ‚îÄ‚îÄ */
        .form-wrapper.register-mode {
            max-width: 540px;
        }

        /* ‚îÄ‚îÄ Two-col grid ‚îÄ‚îÄ */
        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 16px;
        }

        @media (max-width: 520px) {
            .field-row {
                grid-template-columns: 1fr;
            }
        }

        /* ‚îÄ‚îÄ Checkbox group ‚îÄ‚îÄ */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.84rem;
            color: #555;
            margin-bottom: 10px;
        }

        .checkbox-group input[type=checkbox] {
            accent-color: #C4A484;
            width: 16px;
            height: 16px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.88rem;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .25);
            opacity: 0;
            transition: opacity .3s;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-secondary flex-center min-h-screen">

    <div class="login-split-container">
        <!-- Left Side: Image/Brand -->
        <div class="login-image-side">
            <div class="brand-overlay">
                <h1>JisWorld</h1>
                <p>Helping children find their voice.</p>
            </div>
        </div>

        <!-- Right Side: Form -->
        <div class="login-form-side">
            <div class="form-wrapper" id="formWrapper">
                <div class="login-header text-center mb-6">
                    <a href="index.html" class="logo mb-4 inline-block md:hidden">
                        <span class="logo-text">Jis</span><span class="logo-highlight">World</span>
                        <span class="logo-icon">üéà</span>
                    </a>
                    <h2 id="auth-title">Welcome Back!</h2>
                    <p id="auth-subtitle" class="text-gray">Please log in to access your dashboard.</p>
                </div>

                <div class="login-tabs mb-6">
                    <button class="tab-btn active text-[#2D2D2D] border-b-2 border-[#C4A484]"
                        onclick="switchAuthMode('login')">Login</button>
                    <button class="tab-btn text-gray-400 hover:text-[#C4A484]"
                        onclick="switchAuthMode('register')">Register</button>
                </div>

                <!-- Social Auth Buttons -->
                <div class="social-auth mb-6 space-y-3">
                    <button id="googleBtn"
                        class="w-full flex items-center justify-center gap-3 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors bg-white text-gray-700 font-medium">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                        <span class="btn-text">Google</span>
                    </button>
                </div>

                <div class="relative mb-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Or email</span>
                    </div>
                </div>

                <form id="authForm" novalidate>
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REGISTRATION-ONLY FIELDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

                    <!-- First & Last Name row -->
                    <div id="nameFields" class="field-row hidden">
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                            <input type="text" id="firstName"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="Jane" minlength="2" maxlength="50">
                            <div class="field-error" id="err-firstName"></div>
                        </div>
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                            <input type="text" id="lastName"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="Doe" minlength="2" maxlength="50">
                            <div class="field-error" id="err-lastName"></div>
                        </div>
                    </div>

                    <!-- Email (always visible) -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="email"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                            placeholder="name@example.com" required>
                        <div class="field-error" id="err-email"></div>
                    </div>

                    <!-- Password (always visible) -->
                    <div class="form-group mb-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" id="password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <div class="field-error" id="err-password"></div>
                        <!-- Password strength (registration only) -->
                        <div id="strengthWrap" class="password-strength-wrap hidden">
                            <div class="strength-bar-track">
                                <div class="strength-bar-fill" id="strengthFill"></div>
                            </div>
                            <div class="strength-label" id="strengthLabel"></div>
                            <ul class="strength-checklist" id="strengthChecklist">
                                <li id="chk-len">8+ characters</li>
                                <li id="chk-upper">Uppercase letter</li>
                                <li id="chk-lower">Lowercase letter</li>
                                <li id="chk-digit">A number</li>
                                <li id="chk-special">Special character</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Remember Me + Forgot Password (login only) -->
                    <div id="loginExtras" class="mb-4" style="margin-top:4px;">
                        <div class="remember-row">
                            <input type="checkbox" id="rememberMe">
                            <label for="rememberMe">Remember me</label>
                        </div>
                        <a href="#" class="forgot-link" id="forgotLink">Forgot password?</a>
                    </div>

                    <!-- Confirm Password (registration only) -->
                    <div id="confirmPwField" class="form-group mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password *</label>
                        <input type="password" id="confirmPassword"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <div class="field-error" id="err-confirmPassword"></div>
                    </div>

                    <!-- Date of Birth (registration only) -->
                    <div id="dobField" class="form-group mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                        <input type="date" id="dob"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all">
                        <div class="field-error" id="err-dob"></div>
                    </div>

                    <!-- Phone & Address row (registration only) -->
                    <div id="contactFields" class="field-row hidden">
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone <span
                                    style="color:#999;font-weight:400;">(optional)</span></label>
                            <input type="tel" id="phone"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="(555) 123-4567">
                            <div class="field-error" id="err-phone"></div>
                        </div>
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address <span
                                    style="color:#999;font-weight:400;">(optional)</span></label>
                            <input type="text" id="address"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="123 Main St, City">
                        </div>
                    </div>

                    <!-- Role (registration only) -->
                    <div id="roleField" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">I am a... *</label>
                        <select id="roleSelect"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all">
                            <option value="parent">Parent / Guardian</option>
                            <option value="therapist">Therapist</option>
                            <option value="reception">Receptionist</option>
                        </select>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê Parent / Guardian Section ‚ïê‚ïê‚ïê -->
                    <fieldset id="parentGuardianSection" class="hidden">
                        <legend>üë®‚Äçüë©‚Äçüëß Parent / Guardian Details</legend>

                        <div class="field-row" style="margin-top:10px;">
                            <div class="form-group mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Parent Full Name</label>
                                <input type="text" id="parentName"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                    placeholder="Jane Doe" minlength="2" maxlength="100">
                            </div>
                            <div class="form-group mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Parent Email</label>
                                <input type="email" id="parentEmail"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                    placeholder="parent@email.com">
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent Phone</label>
                            <input type="tel" id="parentPhone"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="(555) 987-6543">
                        </div>

                        <hr style="border-color:rgba(196,164,132,.2); margin:12px 0;">

                        <div class="field-row">
                            <div class="form-group mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Child's Name</label>
                                <input type="text" id="childName"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                    placeholder="Child's full name">
                            </div>
                            <div class="form-group mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Child's Date of
                                    Birth</label>
                                <input type="date" id="childDob"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all">
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Child's Therapy Needs</label>
                            <textarea id="childNeeds" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#C4A484] focus:border-[#C4A484] outline-none transition-all"
                                placeholder="Briefly describe any speech, language, or developmental needs..."></textarea>
                        </div>
                    </fieldset>

                    <!-- Terms & Conditions + Newsletter (registration only) -->
                    <div id="termsSection" class="hidden" style="margin-bottom:16px;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="termsCheck">
                            <label for="termsCheck">I agree to the <span class="terms-link"
                                    onclick="alert('Terms & Conditions: By registering you agree to our standard Terms of Service and Privacy Policy.')">Terms
                                    & Conditions</span> *</label>
                        </div>
                        <div class="field-error" id="err-terms" style="margin-top:-6px;margin-bottom:6px;"></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="newsletterCheck">
                            <label for="newsletterCheck">Subscribe to our newsletter for therapy tips & updates</label>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn"
                        class="w-full py-3 bg-[#2D2D2D] hover:bg-[#1a1a1a] text-white font-semibold rounded-lg transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        Log In
                    </button>
                    <div id="auth-error-msg"
                        style="color:#dc2626;font-size:0.85rem;margin-top:0.75rem;min-height:1.2em;text-align:center;">
                    </div>
                </form>

                <div class="text-center mt-6 text-sm">
                    <a href="index.html" class="text-gray-400 hover:text-[#C4A484]">‚Üê Back to Home</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast element for notifications -->
    <div id="toast" class="toast"></div>

    <script>
        console.log("Login Script Loading...");

        // ‚îÄ‚îÄ Supabase Client ‚îÄ‚îÄ
        const SUPABASE_URL = 'https://hhrqjolqkuzwylypekhr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2WZKcFYxtVP8qtdsoLj82w_Jc551SaB';

        let supabaseClient = null;
        try {
            // Determine storage based on Remember Me checkbox
            const storageType = window.localStorage.getItem('jw_remember') === 'true'
                ? window.localStorage : window.sessionStorage;

            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: { storage: storageType }
            });
            console.log("Supabase client created successfully");
        } catch (e) {
            console.error("Failed to create Supabase client:", e);
        }

        // ‚îÄ‚îÄ Toast helper ‚îÄ‚îÄ
        function showToast(msg, duration) {
            duration = duration || 3000;
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(function () { t.classList.remove('show'); }, duration);
        }

        // ‚îÄ‚îÄ Password strength checker ‚îÄ‚îÄ
        function checkPasswordStrength(pw) {
            var checks = {
                len: pw.length >= 8,
                upper: /[A-Z]/.test(pw),
                lower: /[a-z]/.test(pw),
                digit: /[0-9]/.test(pw),
                special: /[^A-Za-z0-9]/.test(pw)
            };
            var score = 0;
            if (checks.len) score++;
            if (checks.upper) score++;
            if (checks.lower) score++;
            if (checks.digit) score++;
            if (checks.special) score++;
            return { checks: checks, score: score };
        }

        function updateStrengthUI(pw) {
            var result = checkPasswordStrength(pw);
            var fill = document.getElementById('strengthFill');
            var label = document.getElementById('strengthLabel');

            // Update checklist
            var ids = { len: 'chk-len', upper: 'chk-upper', lower: 'chk-lower', digit: 'chk-digit', special: 'chk-special' };
            for (var key in ids) {
                var el = document.getElementById(ids[key]);
                if (result.checks[key]) { el.classList.add('met'); }
                else { el.classList.remove('met'); }
            }

            // Update bar
            var pct = (result.score / 5) * 100;
            fill.style.width = pct + '%';

            if (result.score <= 1) {
                fill.style.background = '#dc2626';
                label.textContent = 'Weak';
                label.style.color = '#dc2626';
            } else if (result.score <= 2) {
                fill.style.background = '#f97316';
                label.textContent = 'Fair';
                label.style.color = '#f97316';
            } else if (result.score <= 3) {
                fill.style.background = '#eab308';
                label.textContent = 'Good';
                label.style.color = '#eab308';
            } else if (result.score === 4) {
                fill.style.background = '#84cc16';
                label.textContent = 'Strong';
                label.style.color = '#84cc16';
            } else {
                fill.style.background = '#16a34a';
                label.textContent = 'Excellent';
                label.style.color = '#16a34a';
            }

            if (pw.length === 0) {
                fill.style.width = '0';
                label.textContent = '';
            }
        }

        // ‚îÄ‚îÄ Field validation helpers ‚îÄ‚îÄ
        function setFieldError(id, msg) {
            var el = document.getElementById('err-' + id);
            var inp = document.getElementById(id);
            if (el) el.textContent = msg;
            if (inp) {
                inp.classList.remove('input-valid');
                inp.classList.add('input-error');
            }
        }

        function setFieldValid(id) {
            var el = document.getElementById('err-' + id);
            var inp = document.getElementById(id);
            if (el) el.textContent = '';
            if (inp) {
                inp.classList.remove('input-error');
                inp.classList.add('input-valid');
            }
        }

        function clearFieldState(id) {
            var el = document.getElementById('err-' + id);
            var inp = document.getElementById(id);
            if (el) el.textContent = '';
            if (inp) { inp.classList.remove('input-error', 'input-valid'); }
        }

        var nameRegex = /^[a-zA-Z\s\-']+$/;

        function validateField(id) {
            var inp = document.getElementById(id);
            if (!inp) return true;
            var val = inp.value.trim();

            switch (id) {
                case 'firstName':
                case 'lastName':
                    if (!val) { setFieldError(id, 'This field is required.'); return false; }
                    if (val.length < 2) { setFieldError(id, 'At least 2 characters.'); return false; }
                    if (!nameRegex.test(val)) { setFieldError(id, 'Letters, spaces, hyphens only.'); return false; }
                    setFieldValid(id);
                    return true;

                case 'email':
                    if (!val) { setFieldError(id, 'Email is required.'); return false; }
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)) { setFieldError(id, 'Enter a valid email address.'); return false; }
                    setFieldValid(id);
                    return true;

                case 'password':
                    if (!val) { setFieldError(id, 'Password is required.'); return false; }
                    var isRegister = document.getElementById('submitBtn').textContent.indexOf('Sign Up') !== -1;
                    if (isRegister) {
                        if (val.length < 8) { setFieldError(id, 'Must be at least 8 characters.'); return false; }
                        var res = checkPasswordStrength(val);
                        if (res.score < 4) { setFieldError(id, 'Must include uppercase, lowercase, number, and special character.'); return false; }
                    } else {
                        if (val.length < 6) { setFieldError(id, 'Must be at least 6 characters.'); return false; }
                    }
                    setFieldValid(id);
                    return true;

                case 'confirmPassword':
                    var pw = document.getElementById('password').value;
                    if (!val) { setFieldError(id, 'Please confirm your password.'); return false; }
                    if (val !== pw) { setFieldError(id, 'Passwords do not match.'); return false; }
                    setFieldValid(id);
                    return true;

                case 'dob':
                    if (!val) { setFieldError(id, 'Date of birth is required.'); return false; }
                    if (new Date(val) > new Date()) { setFieldError(id, 'Date of birth cannot be in the future.'); return false; }
                    setFieldValid(id);
                    return true;

                case 'phone':
                    if (!val) { clearFieldState(id); return true; } // optional
                    var digits = val.replace(/\D/g, '');
                    if (digits.length < 10 || digits.length > 15) { setFieldError(id, 'Enter 10‚Äì15 digits.'); return false; }
                    setFieldValid(id);
                    return true;

                default:
                    return true;
            }
        }

        // ‚îÄ‚îÄ Comprehensive registration validation ‚îÄ‚îÄ
        function validateRegistration() {
            var fields = ['firstName', 'lastName', 'email', 'password', 'confirmPassword', 'dob', 'phone'];
            var allValid = true;
            for (var i = 0; i < fields.length; i++) {
                if (!validateField(fields[i])) allValid = false;
            }
            // Terms checkbox
            if (!document.getElementById('termsCheck').checked) {
                document.getElementById('err-terms').textContent = 'You must agree to the Terms & Conditions.';
                allValid = false;
            } else {
                document.getElementById('err-terms').textContent = '';
            }
            return allValid;
        }

        // ‚îÄ‚îÄ Auth handler ‚îÄ‚îÄ
        async function handleAuth(mode, formData) {
            console.log("handleAuth called:", mode);
            if (!supabaseClient) {
                showToast("System Error: Supabase client not initialized.");
                return;
            }

            try {
                var error, userData;

                if (mode === 'login') {
                    var result = await supabaseClient.auth.signInWithPassword({
                        email: formData.email,
                        password: formData.password
                    });
                    error = result.error;
                    userData = result.data ? result.data.user : null;

                    // Remember Me: persist preference
                    if (document.getElementById('rememberMe').checked) {
                        localStorage.setItem('jw_remember', 'true');
                    } else {
                        localStorage.removeItem('jw_remember');
                    }
                } else {
                    var result = await supabaseClient.auth.signUp({
                        email: formData.email,
                        password: formData.password,
                        options: {
                            data: {
                                full_name: formData.firstName + ' ' + formData.lastName,
                                first_name: formData.firstName,
                                last_name: formData.lastName,
                                role: formData.role,
                                phone: formData.phone || null,
                                address: formData.address || null,
                                dob: formData.dob || null,
                                newsletter: formData.newsletter
                            }
                        }
                    });
                    error = result.error;
                    userData = result.data ? result.data.user : null;

                    if (!error && userData) {
                        showToast("Registration successful! Check your email to verify.", 5000);
                    }
                }

                if (error) throw error;

                // Auto-create public.users + public.parents records
                if (userData) {
                    var displayName = mode === 'register'
                        ? formData.firstName + ' ' + formData.lastName
                        : '';
                    await ensureUserRecords(userData, displayName, formData.role || 'parent');
                }

                console.log("Auth success, redirecting...");
                if (formData.role === 'admin' || formData.email.includes('admin')) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'profile.html';
                }

            } catch (error) {
                console.error("Auth Error:", error);
                var errEl = document.getElementById('auth-error-msg');
                if (errEl) errEl.textContent = error.message || "Authentication failed. Please try again.";
            }
        }

        async function ensureUserRecords(user, displayName, role) {
            try {
                var uName = displayName || user.user_metadata?.full_name || user.email.split('@')[0];
                var uRole = role || user.user_metadata?.role || 'parent';

                // Upsert into public.users
                await supabaseClient.from('users').upsert({
                    id: user.id,
                    email: user.email,
                    display_name: uName,
                    role: uRole,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'id' });

                // Auto-create parents record for parent-role users
                if (uRole === 'parent' || uRole === 'user') {
                    var existing = await supabaseClient
                        .from('parents')
                        .select('id')
                        .eq('user_id', user.id)
                        .maybeSingle();

                    if (!existing.data) {
                        await supabaseClient.from('parents').insert({ user_id: user.id });
                        console.log("Created parent record for user:", user.id);
                    }
                }
            } catch (err) {
                console.warn("ensureUserRecords warning (non-blocking):", err);
            }
        }

        async function handleGoogleLogin() {
            console.log("Google login clicked");
            if (!supabaseClient) return;
            try {
                var result = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin + '/profile.html' }
                });
                if (result.error) throw result.error;
            } catch (error) {
                console.error("Google Auth Error:", error);
                showToast(error.message);
            }
        }

        // ‚îÄ‚îÄ Forgot Password handler ‚îÄ‚îÄ
        async function handleForgotPassword() {
            var email = document.getElementById('email').value.trim();
            if (!email) {
                document.getElementById('err-email').textContent = 'Enter your email first, then click Forgot Password.';
                document.getElementById('email').classList.add('input-error');
                document.getElementById('email').focus();
                return;
            }
            if (!supabaseClient) return;
            try {
                var result = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/login.html?reset=true'
                });
                if (result.error) throw result.error;
                showToast("Password reset email sent! Check your inbox.", 5000);
            } catch (err) {
                showToast("Error: " + (err.message || "Could not send reset email."), 4000);
            }
        }

        // ‚îÄ‚îÄ Initialize when DOM is ready ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM Ready - attaching event listeners");

            // Set max date for DOB fields
            var today = new Date().toISOString().split('T')[0];
            var dobInput = document.getElementById('dob');
            var childDobInput = document.getElementById('childDob');
            if (dobInput) dobInput.setAttribute('max', today);
            if (childDobInput) childDobInput.setAttribute('max', today);

            // Google login button
            var googleBtn = document.getElementById('googleBtn');
            if (googleBtn) {
                googleBtn.addEventListener('click', handleGoogleLogin);
            }

            // Forgot password link
            var forgotLink = document.getElementById('forgotLink');
            if (forgotLink) {
                forgotLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    handleForgotPassword();
                });
            }

            // Password strength indicator (real-time)
            var pwInput = document.getElementById('password');
            if (pwInput) {
                pwInput.addEventListener('input', function () {
                    var isRegister = document.getElementById('submitBtn').textContent.indexOf('Sign Up') !== -1;
                    if (isRegister) {
                        updateStrengthUI(this.value);
                    }
                });
            }

            // Real-time validation on blur
            var fieldsToValidate = ['firstName', 'lastName', 'email', 'password', 'confirmPassword', 'dob', 'phone'];
            fieldsToValidate.forEach(function (id) {
                var el = document.getElementById(id);
                if (el) {
                    el.addEventListener('blur', function () {
                        var isRegister = document.getElementById('submitBtn').textContent.indexOf('Sign Up') !== -1;
                        // Only validate registration-specific fields in register mode
                        if (['firstName', 'lastName', 'confirmPassword', 'dob', 'phone'].indexOf(id) !== -1 && !isRegister) return;
                        validateField(id);
                    });
                }
            });

            // Role selector: show/hide parent section
            var roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                roleSelect.addEventListener('change', function () {
                    var parentSection = document.getElementById('parentGuardianSection');
                    if (this.value === 'parent') {
                        parentSection.classList.remove('hidden');
                    } else {
                        parentSection.classList.add('hidden');
                    }
                });
            }

            // Terms checkbox: clear error on check
            var termsCheck = document.getElementById('termsCheck');
            if (termsCheck) {
                termsCheck.addEventListener('change', function () {
                    if (this.checked) document.getElementById('err-terms').textContent = '';
                });
            }

            // Tab switching (exposed globally for onclick handlers)
            window.switchAuthMode = function (mode) {
                console.log("Switching mode:", mode);
                var title = document.getElementById('auth-title');
                var subtitle = document.getElementById('auth-subtitle');
                var submitBtn = document.getElementById('submitBtn');
                var tabs = document.querySelectorAll('.tab-btn');
                var formWrapper = document.getElementById('formWrapper');

                // Registration-only field containers
                var regFields = ['nameFields', 'confirmPwField', 'dobField', 'contactFields',
                    'roleField', 'termsSection', 'strengthWrap'];
                var loginExtras = document.getElementById('loginExtras');

                // Clear all errors
                document.querySelectorAll('.field-error').forEach(function (el) { el.textContent = ''; });
                document.querySelectorAll('.input-error, .input-valid').forEach(function (el) {
                    el.classList.remove('input-error', 'input-valid');
                });
                document.getElementById('auth-error-msg').textContent = '';

                if (mode === 'register') {
                    title.textContent = "Create Account";
                    subtitle.textContent = "Join JisWorld to start your child\'s therapy journey.";
                    submitBtn.textContent = "Sign Up";
                    formWrapper.classList.add('register-mode');

                    regFields.forEach(function (id) {
                        document.getElementById(id).classList.remove('hidden');
                    });
                    loginExtras.classList.add('hidden');

                    // Show parent section if role is parent
                    var parentSection = document.getElementById('parentGuardianSection');
                    if (document.getElementById('roleSelect').value === 'parent') {
                        parentSection.classList.remove('hidden');
                    }

                    tabs[0].classList.remove('active', 'text-[#2D2D2D]', 'border-b-2', 'border-[#C4A484]');
                    tabs[0].classList.add('text-gray-400');
                    tabs[1].classList.add('active', 'text-[#2D2D2D]', 'border-b-2', 'border-[#C4A484]');
                    tabs[1].classList.remove('text-gray-400');

                    // Reset strength bar
                    updateStrengthUI(document.getElementById('password').value);
                } else {
                    title.textContent = "Welcome Back!";
                    subtitle.textContent = "Please log in to access your dashboard.";
                    submitBtn.textContent = "Log In";
                    formWrapper.classList.remove('register-mode');

                    regFields.forEach(function (id) {
                        document.getElementById(id).classList.add('hidden');
                    });
                    document.getElementById('parentGuardianSection').classList.add('hidden');
                    loginExtras.classList.remove('hidden');

                    tabs[1].classList.remove('active', 'text-[#2D2D2D]', 'border-b-2', 'border-[#C4A484]');
                    tabs[1].classList.add('text-gray-400');
                    tabs[0].classList.add('active', 'text-[#2D2D2D]', 'border-b-2', 'border-[#C4A484]');
                    tabs[0].classList.remove('text-gray-400');
                }
            };

            // Form submit handler
            var authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    console.log("Form submit triggered");
                    var errEl = document.getElementById('auth-error-msg');
                    errEl.textContent = '';

                    var submitBtn = document.getElementById('submitBtn');
                    var mode = submitBtn.textContent.indexOf('Sign Up') !== -1 ? 'register' : 'login';

                    if (mode === 'register') {
                        if (!validateRegistration()) return;
                    } else {
                        // Login validation
                        var emailOk = validateField('email');
                        var pwOk = validateField('password');
                        if (!emailOk || !pwOk) return;
                    }

                    var formData = {
                        email: document.getElementById('email').value.trim(),
                        password: document.getElementById('password').value,
                        firstName: document.getElementById('firstName').value.trim(),
                        lastName: document.getElementById('lastName').value.trim(),
                        role: document.getElementById('roleSelect').value || 'parent',
                        dob: document.getElementById('dob').value,
                        phone: document.getElementById('phone').value.trim(),
                        address: document.getElementById('address').value.trim(),
                        newsletter: document.getElementById('newsletterCheck').checked
                    };

                    var originalText = submitBtn.textContent;
                    submitBtn.textContent = "Processing...";
                    submitBtn.disabled = true;

                    handleAuth(mode, formData)
                        .catch(function () { /* error shown inline */ })
                        .finally(function () {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        });
                });
                console.log("Form submit listener attached successfully");
            } else {
                console.error("Auth form NOT found in DOM!");
            }
        });
    </script>

</html>