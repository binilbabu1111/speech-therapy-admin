<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | JisWorld Speech Therapy</title>
    <!-- Use existing styles -->
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Nunito', sans-serif;
            padding: 2rem;
        }

        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        h1 {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-logout {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Nunito', sans-serif;
            padding: 2rem;
            color: #000000;
            /* Force black text */
        }

        td,
        th,
        p,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        span,
        div {
            color: #000000;
            /* Inherit or force black unless overridden */
        }

        th {
            background-color: #f9fafb;
            color: #1f2937;
            /* Very dark gray for headers */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .role-badge {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        #login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .pin-box {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .pin-input {
            margin: 1rem 0;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 200px;
            text-align: center;
            font-size: 1.25rem;
            letter-spacing: 0.25rem;
        }

        .btn-submit {
            background-color: #5BA4CF;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .field-error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 4px;
            font-weight: 500;
            min-height: 15px;
            display: none;
        }

        .field-error.visible {
            display: block;
        }

        .input-error {
            border-color: #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }

        .form-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 1rem;
            text-align: center;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.05);
            border-radius: 0.75rem;
            display: none;
        }

        .form-error.visible {
            display: block;
        }
    </style>
</head>

<body>

    <!-- PIN Protection Overlay -->
    <!-- Login Overlay for Unauthenticated Users -->
    <!-- Login Overlay (Preserved) -->
    <div id="login-overlay" style="display: none;">
        <div class="pin-box" style="width: 350px; text-align: left;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h2 style="margin-bottom: 0.5rem; color: #2d3748;">xADMIN Access</h2>
                <p style="color: #6b7280; font-size: 0.875rem;">Please log in to continue</p>
            </div>
            <form id="admin-login-form">
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; font-size: 0.875rem; color: #4b5563; margin-bottom: 0.25rem;">Email</label>
                    <input type="email" id="admin-email" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; font-size: 0.875rem; color: #4b5563; margin-bottom: 0.25rem;">Password</label>
                    <input type="password" id="admin-password" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; color: #4b5563; margin-bottom: 0.25rem;">Admin
                        Key</label>
                    <input type="password" id="admin-key" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                        placeholder="Enter 6-digit key">
                </div>
                <button type="submit" class="btn-submit">Login to Dashboard</button>
            </form>
            <p id="auth-error"
                style="color: #ef4444; margin-top: 1rem; font-size: 0.875rem; text-align: center; display: none;"></p>
        </div>
    </div>

    <!-- xADMIN Layout -->
    <div class="admin-layout" id="admin-dashboard" style="display: none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <div class="w-8 h-8 rounded-full bg-[#C4A484] flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                        </path>
                    </svg>
                </div>
                <span class="font-bold text-lg">JisWorld Admin</span>
            </div>
            <nav class="admin-nav">
                <a href="#" class="nav-item active" onclick="switchSection('dashboard', this)">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="#" class="nav-item" onclick="switchSection('users', this)">
                    <span class="nav-icon">üë•</span> User Management
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üì©</span> Inquiries <span
                        class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto">3</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìÖ</span> Appointments
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìù</span> Therapy Plans
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìã</span> Assessments
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üí≥</span> Billing
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìÇ</span> Documents
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üñ•Ô∏è</span> CMS
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üîî</span> Notifications
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìà</span> Reports
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span> Settings
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <a href="#" onclick="endSession()"
                    class="flex items-center gap-2 text-red-400 hover:text-red-300 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Topbar -->
            <header class="admin-topbar">
                <h2 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                        <svg class="w-6 h-6 text-gray-500 cursor-pointer hover:text-gray-700" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-center gap-2">
                        <div
                            class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">
                            A</div>
                        <span class="text-sm font-medium text-gray-700">Admin User</span>
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Area -->
            <div class="admin-content">

                <!-- MODULE 1: DASHBOARD -->
                <section id="section-dashboard" class="admin-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>
                                <div class="stat-value">24</div>
                                <div class="stat-label">Total Students</div>
                            </div>
                            <div class="stat-icon bg-blue-100 text-blue-600">üéì</div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <div class="stat-value">3</div>
                                <div class="stat-label">New Inquiries</div>
                            </div>
                            <div class="stat-icon bg-yellow-100 text-yellow-600">üì©</div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <div class="stat-value">12</div>
                                <div class="stat-label">Appointments Today</div>
                            </div>
                            <div class="stat-icon bg-green-100 text-green-600">üìÖ</div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <div class="stat-value">$4.2k</div>
                                <div class="stat-label">Pending Payments</div>
                            </div>
                            <div class="stat-icon bg-red-100 text-red-600">üí∞</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button
                                    class="p-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 flex flex-col items-center gap-2 transition-colors">
                                    <span class="text-2xl">‚ûï</span>
                                    <span class="text-sm font-medium text-gray-600">New Appointment</span>
                                </button>
                                <button
                                    class="p-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 flex flex-col items-center gap-2 transition-colors">
                                    <span class="text-2xl">üìù</span>
                                    <span class="text-sm font-medium text-gray-600">Add Therapy Plan</span>
                                </button>
                                <button
                                    class="p-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 flex flex-col items-center gap-2 transition-colors">
                                    <span class="text-2xl">üë§</span>
                                    <span class="text-sm font-medium text-gray-600">Register Student</span>
                                </button>
                                <button
                                    class="p-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 flex flex-col items-center gap-2 transition-colors">
                                    <span class="text-2xl">üßæ</span>
                                    <span class="text-sm font-medium text-gray-600">Create Invoice</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Recent Inquiries</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <div class="font-bold text-sm text-gray-800">Sarah Johnson</div>
                                        <div class="text-xs text-gray-500">Concern: Speech Delay (Age 4)</div>
                                    </div>
                                    <span
                                        class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">New</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <div class="font-bold text-sm text-gray-800">Mike Peters</div>
                                        <div class="text-xs text-gray-500">Concern: Stuttering (Age 7)</div>
                                    </div>
                                    <span
                                        class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Contacted</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- MODULE 2: USER MANAGEMENT (Restored) -->
                <section id="section-users" class="admin-section">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-100">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">Registered Users</h3>
                                <p class="text-sm text-gray-500">Manage parent and student accounts</p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">Export
                                    CSV</button>
                                <button
                                    class="px-4 py-2 text-sm bg-[#C4A484] text-white rounded-lg hover:bg-[#A38568]">Add
                                    User</button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="flex border-b border-gray-200 px-6">
                            <button class="px-4 py-3 text-sm font-medium text-[#C4A484] border-b-2 border-[#C4A484]"
                                onclick="currentTab='users'; renderUsers()">Parents</button>
                            <button class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                                onclick="currentTab='appointments'; loadUsers()">Students</button>
                            <button
                                class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">Therapists</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            User</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Role</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Joined</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body" class="divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div id="loading-users" class="text-center py-8 text-gray-500">Loading users...</div>
                            <div id="empty-state-users" class="hidden text-center py-12">
                                <div class="text-4xl mb-2">üë•</div>
                                <h3 class="text-lg font-medium text-gray-900">No users found</h3>
                                <p class="text-gray-500">Get started by inviting parents.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Placeholder for future modules -->
                <!-- MODULE 3: INQUIRY MANAGEMENT -->
                <section id="section-inquiries" class="admin-section">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-100">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">Inquiry Management</h3>
                                <p class="text-sm text-gray-500">Track and manage new leads</p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">Export
                                    CSV</button>
                            </div>
                        </div>

                        <!-- Status Tabs -->
                        <div class="flex border-b border-gray-200 px-6 overflow-x-auto">
                            <button class="px-4 py-3 text-sm font-medium text-[#C4A484] border-b-2 border-[#C4A484]"
                                onclick="filterInquiries('all', this)">All</button>
                            <button class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                                onclick="filterInquiries('new', this)">New <span id="count-new"
                                    class="bg-red-100 text-red-600 text-xs px-1.5 rounded-full ml-1">0</span></button>
                            <button class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                                onclick="filterInquiries('contacted', this)">Contacted</button>
                            <button class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                                onclick="filterInquiries('converted', this)">Converted</button>
                            <button class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                                onclick="filterInquiries('closed', this)">Closed</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Parent Name</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Child Info</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Contact</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Notes</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inquiries-table-body" class="divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div id="loading-inquiries" class="text-center py-8 text-gray-500">Loading inquiries...
                            </div>
                            <div id="empty-state-inquiries" class="hidden text-center py-12">
                                <div class="text-4xl mb-2">üì©</div>
                                <h3 class="text-lg font-medium text-gray-900">No inquiries found</h3>
                                <p class="text-gray-500">New website submissions will appear here.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- MODULE 4: APPOINTMENT MANAGEMENT (SESSIONS) -->
                <section id="section-appointments" class="admin-section">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden h-full flex flex-col">
                        <div class="flex justify-between items-center p-6 border-b border-gray-100 flex-shrink-0">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">Appointment Calendar</h3>
                                <p class="text-sm text-gray-500">Manage therapy sessions</p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">List
                                    View</button>
                                <button class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"
                                    onclick="alert('Calendar View coming soon')">Calendar View</button>
                                <button class="px-4 py-2 text-sm bg-[#8F9779] text-white rounded-lg hover:bg-[#7A8268]"
                                    onclick="alert('Add Session Modal coming soon')">+ New Session</button>
                            </div>
                        </div>

                        <!-- Calendar Toolbar -->
                        <div class="flex items-center justify-between px-6 py-3 border-b border-gray-200 bg-gray-50">
                            <div class="flex items-center gap-4">
                                <button class="text-gray-500 hover:text-gray-700 font-bold">&lt;</button>
                                <span class="font-bold text-gray-700">February 2026</span>
                                <button class="text-gray-500 hover:text-gray-700 font-bold">&gt;</button>
                            </div>
                            <div class="flex gap-2 text-sm">
                                <span
                                    class="px-3 py-1 bg-white border border-gray-300 rounded-md shadow-sm">Today</span>
                            </div>
                        </div>

                        <!-- Calendar Grid / List Area -->
                        <div class="flex-1 overflow-y-auto p-0 relative">
                            <!-- Simple List for now -->
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b border-gray-200 sticky top-0">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider w-32">
                                            Date/Time</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Session Details</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Therapist</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Student</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sessions-table-body" class="divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>

                            <div id="loading-sessions"
                                class="hidden absolute inset-0 bg-white/50 flex items-center justify-center">
                                <span class="text-gray-500">Loading schedule...</span>
                            </div>
                            <div id="empty-state-sessions"
                                class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                <div class="text-4xl mb-2">üìÖ</div>
                                <p>No sessions scheduled for this period.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- MODULE 6: BILLING & INVOICES (Phase 1 MVP) -->
                <section id="section-invoices" class="admin-section">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-[#2D2D2D] input-font">Billing & Invoices</h2>
                            <p class="text-gray-500 mt-1">Track payments and outstanding balances.</p>
                        </div>
                        <button
                            onclick="document.getElementById('invoice-modal').classList.remove('hidden'); loadParentOptionsForInvoice();"
                            class="flex items-center gap-2 bg-[#2D2D2D] text-white px-5 py-2.5 rounded-xl hover:bg-[#1a1a1a] transition-colors shadow-lg shadow-gray-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            Create Invoice
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50/50 border-b border-gray-100">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Invoice ID</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Parent/Payer</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Amount</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Due Date</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-table-body" class="divide-y divide-gray-100">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <div id="loading-invoices" class="hidden p-8 text-center text-gray-500">Loading billing data...
                        </div>
                        <div id="empty-state-invoices" class="hidden p-12 text-center">
                            <div
                                class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900">No invoices generated</h3>
                            <p class="text-gray-500 mt-1">Create an invoice to start tracking payments.</p>
                        </div>
                    </div>
                </section>

                <!-- ADD INVOICE MODAL -->
                <div id="invoice-modal"
                    class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 animate-fadeIn">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-[#2D2D2D]">Create New Invoice</h3>
                            <button onclick="document.getElementById('invoice-modal').classList.add('hidden')"
                                class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form id="add-invoice-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bill To (Parent)</label>
                                <select name="parent_id" id="invoice-parent-select" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <option value="">-- Select Parent --</option>
                                    <!-- Populated by JS -->
                                </select>
                                <div class="field-error" id="err-invoice-parent-select"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                                    <input type="number" step="0.01" id="inv-amount" name="amount" required
                                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <div class="field-error" id="err-inv-amount"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                    <input type="date" id="inv-due-date" name="due_date" required
                                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <div class="field-error" id="err-inv-due-date"></div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select name="status"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <option value="Pending">Pending</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Overdue">Overdue</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="form-error" id="invoice-error-msg"></div>

                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button"
                                    onclick="document.getElementById('invoice-modal').classList.add('hidden')"
                                    class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">Cancel</button>
                                <button type="submit"
                                    class="px-6 py-2 bg-[#C4A484] text-white font-medium rounded-lg hover:bg-[#b08d6f] transition-colors shadow-lg shadow-[#C4A484]/20">Generate
                                    Invoice</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- STUDENT MANAGEMENT MODULE (Module 2 Extended) -->
                <section id="section-students" class="admin-section">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-[#2D2D2D] input-font">Student Management</h2>
                            <p class="text-gray-500 mt-1">Manage student profiles and therapy status.</p>
                        </div>
                        <button
                            onclick="document.getElementById('student-modal').classList.remove('hidden'); loadParentOptions();"
                            class="flex items-center gap-2 bg-[#2D2D2D] text-white px-5 py-2.5 rounded-xl hover:bg-[#1a1a1a] transition-colors shadow-lg shadow-gray-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Student
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50/50 border-b border-gray-100">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Student Name</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Details</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Parent/Guardian</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body" class="divide-y divide-gray-100">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Loading / Empty States -->
                        <div id="loading-students" class="hidden p-8 text-center text-gray-500">Loading students...
                        </div>
                        <div id="empty-state-students" class="hidden p-12 text-center">
                            <div
                                class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900">No students yet</h3>
                            <p class="text-gray-500 mt-1">Get started by adding a new student profile.</p>
                        </div>
                    </div>
                </section>

                <!-- ADD STUDENT MODAL -->
                <div id="student-modal"
                    class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 animate-fadeIn">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-[#2D2D2D]">Add New Student</h3>
                            <button onclick="document.getElementById('student-modal').classList.add('hidden')"
                                class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form id="add-student-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                    <input type="text" id="s-first-name" name="first_name" required
                                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <div class="field-error" id="err-s-first-name"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                    <input type="text" id="s-last-name" name="last_name" required
                                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <div class="field-error" id="err-s-last-name"></div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                <input type="date" id="s-dob" name="dob"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                <div class="field-error" id="err-s-dob"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Link Parent
                                    Account</label>
                                <select name="parent_id" id="parent-select"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all">
                                    <option value="">-- No Parent Linked Yet --</option>
                                    <!-- Populated by JS -->
                                </select>
                                <p class="text-xs text-gray-500 mt-1">If parent isn't registered, leave blank.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Diagnosis /
                                    Needs</label>
                                <textarea id="s-diagnosis" name="diagnosis" rows="2"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#C4A484]/20 focus:border-[#C4A484] outline-none transition-all"></textarea>
                                <div class="field-error" id="err-s-diagnosis"></div>
                            </div>
                            <div class="form-error" id="student-error-msg"></div>

                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button"
                                    onclick="document.getElementById('student-modal').classList.add('hidden')"
                                    class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">Cancel</button>
                                <button type="submit"
                                    class="px-6 py-2 bg-[#C4A484] text-white font-medium rounded-lg hover:bg-[#b08d6f] transition-colors shadow-lg shadow-[#C4A484]/20">Save
                                    Student</button>
                            </div>
                        </form>
                    </div>
                </div>

                <script type="module" src="script.js"></script>
                <script type="module" src="session-manager.js"></script>
                <script type="module">
                    import { validators, toggleError, clearAllErrors, initRealTimeValidation } from './validation.js';
                    import { supabase } from './supabase-config.js';
                    import { getAllUsers, checkAdminStatus, upsertUser, updateUserStatus } from './db-service.js';

                    // Admin Key for client-side check
                    const ADMIN_KEY_HASH = '123456';

                    // DOM Elements
                    const loginOverlay = document.getElementById('login-overlay');
                    const dashboardContainer = document.getElementById('admin-dashboard');

                    // State
                    window.currentSection = 'dashboard';

                    // Initialize
                    window.addEventListener('load', () => {
                        checkAccess();
                    });

                    // ---------------------------------------------------------
                    // ACCESS CONTROL
                    // ---------------------------------------------------------
                    async function checkAccess() {
                        try {
                            const { data: { session } } = await supabase.auth.getSession();

                            if (!session) {
                                showLogin();
                                return;
                            }

                            // Verify Admin Role
                            const status = await checkAdminStatus(session.user.id);
                            if (!status.isAdmin) {
                                const role = status.role || 'none';
                                const userEmail = session.user.email;

                                alert(`Access Denied!\n\nUser: ${userEmail}\nCurrent Role: ${role}\n\nTo access this page, you must update this user's role to 'admin' in the Supabase SQL Editor.`);

                                await supabase.auth.signOut();
                                showLogin();
                                return;
                            }

                            // Access Granted
                            showDashboard(session.user);
                        } catch (err) {
                            console.error("checkAccess error:", err);
                            showLogin();
                        }
                    }

                    function showLogin() {
                        loginOverlay.style.display = 'flex';
                        if (dashboardContainer) dashboardContainer.style.display = 'none';
                    }

                    function showDashboard(user) {
                        loginOverlay.style.display = 'none';
                        if (dashboardContainer) {
                            dashboardContainer.style.display = 'flex'; // Flex for sidebar layout
                            loadDashboardStats();
                        }
                    }

                    const loginForm = document.getElementById('admin-login-form');
                    if (loginForm) {
                        initRealTimeValidation('#admin-login-form');
                        loginForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const errorMsg = document.getElementById('auth-error');
                            clearAllErrors('#admin-login-form');

                            const email = document.getElementById('admin-email').value.trim();
                            const password = document.getElementById('admin-password').value;
                            const key = document.getElementById('admin-key').value.trim();

                            let hasError = false;
                            if (!toggleError('admin-email', "Email required", validators.isRequired(email))) hasError = true;
                            else if (!toggleError('admin-email', "Invalid format", validators.isEmail(email))) hasError = true;

                            if (!toggleError('admin-password', "Password required", validators.isRequired(password))) hasError = true;
                            if (!toggleError('admin-key', "Key required", validators.isRequired(key))) hasError = true;

                            if (hasError) return;

                            if (key !== ADMIN_KEY_HASH) {
                                errorMsg.textContent = "Invalid Admin Key.";
                                errorMsg.classList.add('visible');
                                return;
                            }

                            try {
                                const { data, error } = await supabase.auth.signInWithPassword({
                                    email, password
                                });
                                if (error) throw error;
                                checkAccess(); // Re-verify
                            } catch (err) {
                                errorMsg.textContent = err.message || "Login failed.";
                                errorMsg.style.display = 'block';
                            }
                        });
                    }

                    window.endSession = async () => {
                        await supabase.auth.signOut();
                        window.location.reload();
                    }

                    // ---------------------------------------------------------
                    // NAVIGATION & LAYOUT
                    // ---------------------------------------------------------
                    window.switchSection = (sectionId, linkElement) => {
                        // 1. Update Sidebar Active State
                        if (linkElement) {
                            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                            linkElement.classList.add('active');
                        }

                        // 2. Hide all sections
                        document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));

                        // 3. Show target section
                        const target = document.getElementById(`section-${sectionId}`);
                        if (target) {
                            target.classList.add('active');
                        }

                        // 4. Update Header Title
                        const titles = {
                            'dashboard': 'Dashboard',
                            'users': 'User Management',
                            'inquiries': 'Inquiry Management'
                        };
                        const titleEl = document.getElementById('page-title');
                        if (titleEl) titleEl.textContent = titles[sectionId] || 'Admin';

                        // 5. Load Data if needed
                        if (sectionId === 'users') loadUsers();
                        if (sectionId === 'dashboard') loadDashboardStats();
                    };

                    // ---------------------------------------------------------
                    // DASHBOARD MODULE
                    // ---------------------------------------------------------
                    async function loadDashboardStats() {
                        // Mock Data for now - replace with real DB counts later
                        // document.getElementById('total-users-count').textContent = '...';
                    }

                    // ---------------------------------------------------------
                    // USER MANAGEMENT MODULE
                    // ---------------------------------------------------------
                    window.loadUsers = async () => {
                        const tbody = document.getElementById('user-table-body');
                        const loading = document.getElementById('loading-users');
                        const empty = document.getElementById('empty-state-users');

                        if (!tbody) return;

                        tbody.innerHTML = '';
                        if (loading) loading.style.display = 'block';
                        if (empty) empty.style.display = 'none';

                        try {
                            const users = await getAllUsers();
                            if (loading) loading.style.display = 'none';

                            if (!users || users.length === 0) {
                                if (empty) empty.style.display = 'block';
                                return;
                            }

                            renderUsers(users);
                            // Update Dashboard Count real-time if possible
                            // document.getElementById('total-users').textContent = users.length;
                        } catch (error) {
                            console.error("Error loading users:", error);
                            if (loading) loading.textContent = "Error loading data.";
                        }
                    };

                    function renderUsers(users) {
                        const tbody = document.getElementById('user-table-body');
                        if (!tbody) return;

                        tbody.innerHTML = '';

                        users.forEach(user => {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 transition-colors";

                            const date = new Date(user.created_at).toLocaleDateString();
                            const statusColor = user.status === 'blocked' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';

                            tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-sm font-bold text-gray-600 mr-3">
                                ${user.email.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${user.email}</div>
                                <div class="text-xs text-gray-500">ID: ...${user.id.slice(-4)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium">${user.role || 'user'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${user.status || 'active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button onclick="toggleUserStatus('${user.id}', '${user.email}', '${user.status || 'active'}')"
                                class="text-indigo-600 hover:text-indigo-900 mr-3">
                                ${user.status === 'blocked' ? 'Unblock' : 'Block'}
                        </button>
                    </td>
                `;
                            tbody.appendChild(tr);
                        });
                    }


                    window.toggleUserStatus = async (id, email, currentStatus) => {
                        const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
                        if (!confirm(`Are you sure you want to ${newStatus === 'blocked' ? 'BLOCK' : 'UNBLOCK'} ${email}?`)) {
                            return;
                        }

                        try {
                            await updateUserStatus(id, newStatus);
                            loadUsers(); // Refresh list
                        } catch (err) {
                            alert("Failed to update status: " + err.message);
                        }
                    };

                    // ---------------------------------------------------------
                    // INQUIRY MANAGEMENT MODULE
                    // ---------------------------------------------------------

                    // Enhance switchSection to load inquiries
                    window.switchSection = (sectionId, linkElement) => {
                        if (linkElement) {
                            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                            linkElement.classList.add('active');
                        }
                        document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
                        const target = document.getElementById(`section-${sectionId}`);
                        if (target) target.classList.add('active');

                        const titleEl = document.getElementById('page-title');
                        if (titleEl) {
                            const titles = { 'dashboard': 'Dashboard', 'users': 'User Management', 'inquiries': 'Inquiry Management' };
                            titleEl.textContent = titles[sectionId] || 'Admin';
                        }

                        if (sectionId === 'users') loadUsers();
                        if (sectionId === 'dashboard') loadDashboardStats();
                        if (sectionId === 'inquiries') loadInquiries();
                    };

                    let allInquiries = []; // Cache for filtering

                    window.loadInquiries = async () => {
                        const tbody = document.getElementById('inquiries-table-body');
                        const loading = document.getElementById('loading-inquiries');
                        const empty = document.getElementById('empty-state-inquiries');

                        if (!tbody) return;

                        tbody.innerHTML = '';
                        if (loading) loading.style.display = 'block';
                        if (empty) empty.style.display = 'none';

                        try {
                            // Use 'getInquiries' for Leads
                            const { getInquiries } = await import('./db-service.js');
                            allInquiries = await getInquiries();

                            if (loading) loading.style.display = 'none';

                            if (!allInquiries || allInquiries.length === 0) {
                                if (empty) empty.style.display = 'block';
                                return;
                            }

                            // Update Badge Count
                            const newCount = allInquiries.filter(i => (i.status || 'New').toLowerCase() === 'new').length;
                            const countBadge = document.getElementById('count-new');
                            if (countBadge) countBadge.textContent = newCount;

                            filterInquiries('all', null);

                        } catch (error) {
                            console.error("Error loading inquiries:", error);
                            if (loading) loading.textContent = "Error loading data.";
                        }
                    };

                    window.filterInquiries = (status, btn) => {
                        // Update tabs
                        if (btn) {
                            const parent = btn.parentElement;
                            parent.querySelectorAll('button').forEach(b => {
                                b.classList.remove('text-[#C4A484]', 'border-b-2', 'border-[#C4A484]');
                                b.classList.add('text-gray-500');
                            });
                            btn.classList.remove('text-gray-500');
                            btn.classList.add('text-[#C4A484]', 'border-b-2', 'border-[#C4A484]');
                        }

                        const filtered = status === 'all'
                            ? allInquiries
                            : allInquiries.filter(i => (i.status || 'New').toLowerCase() === status.toLowerCase());

                        renderInquiries(filtered);
                    };

                    function renderInquiries(items) {
                        const tbody = document.getElementById('inquiries-table-body');
                        if (!tbody) return;
                        tbody.innerHTML = '';

                        items.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 transition-colors";

                            const date = new Date(item.created_at).toLocaleDateString();
                            const status = (item.status || 'new').toLowerCase();
                            let badgeClass = 'bg-gray-100 text-gray-800';
                            if (status === 'new') badgeClass = 'bg-red-100 text-red-800';
                            if (status === 'contacted') badgeClass = 'bg-blue-100 text-blue-800';
                            if (status === 'converted') badgeClass = 'bg-green-100 text-green-800';
                            if (status === 'closed') badgeClass = 'bg-gray-200 text-gray-600';

                            // Fix: Use child_info from DB, not child_name
                            const childDisplay = item.child_info || 'N/A';

                            tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${childDisplay}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        <div>${item.email}</div>
                        <div class="text-xs">${item.phone || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${badgeClass}">
                            ${status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${item.message || ''}">
                        ${item.admin_notes || item.message || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium flex flex-col gap-2">
                        <select onchange="window.updateInquiryStatus('${item.id}', this.value)" class="text-xs border rounded p-1 mb-1">
                            <option value="new" ${status === 'new' ? 'selected' : ''}>New</option>
                            <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="converted" ${status === 'converted' ? 'selected' : ''}>Converted</option>
                            <option value="closed" ${status === 'closed' ? 'selected' : ''}>Closed</option>
                        </select>
                        ${status !== 'converted' ?
                                    `<button onclick="convertInquiryToStudent('${item.id}')" class="text-xs bg-[#2D2D2D] text-white px-2 py-1 rounded hover:bg-gray-700">
                                Convert
                            </button>` : ''}
                    </td>
                `;
                            tbody.appendChild(tr);
                        });
                    }

                    window.updateInquiryStatus = async (id, newStatus) => {
                        const { updateInquiry } = await import('./db-service.js');
                        try {
                            await updateInquiry(id, { status: newStatus });
                            const idx = allInquiries.findIndex(i => i.id === id);
                            if (idx !== -1) allInquiries[idx].status = newStatus;

                            // Re-render
                            const activeBtn = document.querySelector('#section-inquiries .border-b-2');
                            const currentFilter = activeBtn ? activeBtn.textContent.trim().toLowerCase().split(' ')[0] : 'all';
                            filterInquiries(currentFilter === 'all' ? 'all' : currentFilter, null);

                        } catch (err) {
                            alert("Failed to update: " + err.message);
                        }
                    };

                    window.convertInquiryToStudent = (id) => {
                        const inquiry = allInquiries.find(i => i.id === id);
                        if (!inquiry) return;

                        // Switch to Student Section & Open Modal
                        switchSection('students', document.querySelector('a[onclick*="students"]'));
                        document.getElementById('student-modal').classList.remove('hidden');
                        loadParentOptions();

                        // Pre-fill Form
                        const form = document.getElementById('add-student-form');
                        if (!form) return;

                        // Try to parse "Child: Name, Age: X"
                        let firstName = '';
                        let lastName = '';
                        if (inquiry.child_info) {
                            // Simple heuristic: Remove "Child:" labels and take first string
                            let clean = inquiry.child_info.replace(/Child:/i, '').replace(/Age:.*/i, '').trim();
                            if (clean.includes(',')) clean = clean.split(',')[0].trim();

                            const parts = clean.split(' ');
                            if (parts.length > 0) firstName = parts[0];
                            if (parts.length > 1) lastName = parts.slice(1).join(' ');
                        }

                        form.querySelector('[name="first_name"]').value = firstName;
                        form.querySelector('[name="last_name"]').value = lastName;
                        form.querySelector('[name="diagnosis"]').value = `From Inquiry: ${inquiry.message || ''}`;

                        alert(`Step 1: Create Student Profile.\n\nTip: The parent "${inquiry.name}" (${inquiry.email}) needs to register separately to be linked.`);
                    };

                    // ---------------------------------------------------------
                    // SESSION MANAGEMENT MODULE (Module 4)
                    // ---------------------------------------------------------
                    // Update switchSection to handle 'students' and 'invoices'
                    window.switchSection = (sectionId, linkElement) => {
                        if (linkElement) {
                            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                            linkElement.classList.add('active');
                        }
                        document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
                        const target = document.getElementById(`section-${sectionId}`);
                        if (target) target.classList.add('active');

                        const titleEl = document.getElementById('page-title');
                        if (titleEl) {
                            const titles = {
                                'dashboard': 'Dashboard',
                                'users': 'User Management',
                                'inquiries': 'Inquiry Management',
                                'appointments': 'Session Calendar',
                                'students': 'Student Management',
                                'invoices': 'Billing & Invoices'
                            };
                            titleEl.textContent = titles[sectionId] || 'Admin';
                        }

                        if (sectionId === 'users') loadUsers();
                        if (sectionId === 'dashboard') loadDashboardStats();
                        if (sectionId === 'inquiries') loadInquiries();
                        if (sectionId === 'appointments') loadSessions();
                        if (sectionId === 'students') loadStudents();
                        if (sectionId === 'invoices') loadInvoices();
                    };

                    window.loadSessions = async () => {
                        const tbody = document.getElementById('sessions-table-body');
                        const loading = document.getElementById('loading-sessions');
                        const empty = document.getElementById('empty-state-sessions');

                        if (!tbody) return;

                        tbody.innerHTML = '';
                        if (loading) loading.style.display = 'flex';
                        if (empty) empty.style.display = 'none';

                        try {
                            // Use 'getAppointments' for Calendar Sessions
                            const { getAppointments } = await import('./db-service.js');
                            const sessions = await getAppointments();

                            if (loading) loading.style.display = 'none';

                            if (!sessions || sessions.length === 0) {
                                if (empty) empty.style.display = 'flex';
                                return;
                            }

                            renderSessions(sessions);

                        } catch (error) {
                            console.error("Error loading sessions:", error);
                            if (loading) loading.textContent = "Error loading data.";
                        }
                    };

                    function renderSessions(sessions) {
                        const tbody = document.getElementById('sessions-table-body');
                        if (!tbody) return;
                        tbody.innerHTML = '';

                        sessions.forEach(session => {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 transition-colors";

                            const start = new Date(session.date_time); // Changed from start_time
                            const date = start.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                            const time = start.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });

                            let statusColor = 'bg-gray-100 text-gray-800';
                            if (session.status === 'Scheduled') statusColor = 'bg-blue-100 text-blue-800';
                            if (session.status === 'Completed') statusColor = 'bg-green-100 text-green-800';
                            if (session.status === 'Cancelled') statusColor = 'bg-red-100 text-red-800';

                            tr.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">
                        ${date}<br><span class="text-gray-500 font-normal">${time}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div class="font-medium">${session.mode || 'In-Person'}</div>
                        <div class="text-xs text-gray-500">Therapy Session</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${session.therapist?.specialization || 'Therapist'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${session.student?.first_name || 'Student'} ${session.student?.last_name || ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${(session.status || 'Scheduled').toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    </td>
                `;
                            tbody.appendChild(tr);
                        });
                    }

                    // ---------------------------------------------------------
                    // STUDENT MANAGEMENT MODULE (Module 2)
                    // ---------------------------------------------------------

                    window.loadStudents = async () => {
                        const tbody = document.getElementById('students-table-body');
                        const loading = document.getElementById('loading-students');
                        const empty = document.getElementById('empty-state-students');

                        if (!tbody) return;

                        tbody.innerHTML = '';
                        if (loading) loading.style.display = 'block';
                        if (empty) empty.style.display = 'none';

                        try {
                            const { getStudents } = await import('./db-service.js');
                            const students = await getStudents();

                            if (loading) loading.style.display = 'none';

                            if (!students || students.length === 0) {
                                if (empty) empty.style.display = 'block';
                                return;
                            }

                            renderStudents(students);
                        } catch (error) {
                            console.error("Error loading students:", error);
                            if (loading) loading.textContent = "Error loading data.";
                        }
                    };

                    function renderStudents(students) {
                        const tbody = document.getElementById('students-table-body');
                        if (!tbody) return;
                        tbody.innerHTML = '';

                        students.forEach(student => {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 transition-colors";

                            const parentName = student.parent?.user?.name || 'Unlinked';
                            const parentEmail = student.parent?.user?.email || '-';

                            let statusColor = 'bg-green-100 text-green-800';
                            if (student.therapy_status === 'Waiting') statusColor = 'bg-yellow-100 text-yellow-800';
                            if (student.therapy_status === 'Completed') statusColor = 'bg-gray-100 text-gray-800';

                            tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${student.first_name} ${student.last_name}</div>
                        <div class="text-xs text-gray-500">Grade: ${student.grade || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${student.diagnosis || ''}">
                        ${student.diagnosis || 'No specific diagnosis'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${parentName}</div>
                        <div class="text-xs text-gray-500">${parentEmail}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${student.therapy_status || 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                    </td>
                `;
                            tbody.appendChild(tr);
                        });
                    }

                    window.loadParentOptions = async () => {
                        const select = document.getElementById('parent-select');
                        if (!select || select.dataset.loaded) return;

                        try {
                            const { getParents } = await import('./db-service.js');
                            const parents = await getParents();

                            // Keep first option
                            select.innerHTML = '<option value="">-- No Parent Linked Yet --</option>';

                            parents.forEach(p => {
                                const option = document.createElement('option');
                                option.value = p.id;
                                option.textContent = `${p.name} (${p.email})`;
                                select.appendChild(option);
                            });
                            select.dataset.loaded = "true";
                        } catch (err) {
                            console.error("Error loading parents:", err);
                        }
                    };

                    // Form Handler
                    const addStudentForm = document.getElementById('add-student-form');
                    if (addStudentForm) {
                        initRealTimeValidation('#add-student-form');
                        addStudentForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const errorMsg = document.getElementById('student-error-msg');
                            clearAllErrors('#add-student-form');

                            const btn = addStudentForm.querySelector('button[type="submit"]');
                            const originalText = btn.textContent;

                            const formData = new FormData(addStudentForm);
                            const studentData = Object.fromEntries(formData.entries());

                            let hasError = false;
                            if (!toggleError('s-first-name', "Required", validators.isRequired(studentData.first_name))) hasError = true;
                            if (!toggleError('s-last-name', "Required", validators.isRequired(studentData.last_name))) hasError = true;
                            if (!toggleError('s-dob', "Birth date required", validators.isRequired(studentData.dob))) hasError = true;

                            if (hasError) return;

                            btn.disabled = true;
                            btn.textContent = "Saving...";

                            // Cleanup empty parent_id
                            if (!studentData.parent_id) delete studentData.parent_id;

                            try {
                                const { createStudent } = await import('./db-service.js');
                                await createStudent(studentData);

                                alert("Student added successfully!");
                                document.getElementById('student-modal').classList.add('hidden');
                                addStudentForm.reset();
                                loadStudents(); // Refresh table

                            } catch (err) {
                                errorMsg.textContent = "Error: " + err.message;
                                errorMsg.classList.add('visible');
                            } finally {
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                        });
                    }

                    // ---------------------------------------------------------
                    // INVOICE MANAGEMENT MODULE (Module 5)
                    // ---------------------------------------------------------

                    window.loadInvoices = async () => {
                        const tbody = document.getElementById('invoices-table-body');
                        const loading = document.getElementById('loading-invoices');
                        const empty = document.getElementById('empty-state-invoices');

                        if (!tbody) return;

                        tbody.innerHTML = '';
                        if (loading) loading.style.display = 'block';
                        if (empty) empty.style.display = 'none';

                        try {
                            const { getInvoices } = await import('./db-service.js');
                            const invoices = await getInvoices();

                            if (loading) loading.style.display = 'none';

                            if (!invoices || invoices.length === 0) {
                                if (empty) empty.style.display = 'block';
                                return;
                            }

                            renderInvoices(invoices);
                        } catch (error) {
                            console.error("Error loading invoices:", error);
                            if (loading) loading.textContent = "Error loading data.";
                        }
                    };

                    function renderInvoices(invoices) {
                        const tbody = document.getElementById('invoices-table-body');
                        if (!tbody) return;
                        tbody.innerHTML = '';

                        invoices.forEach(inv => {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 transition-colors";

                            const invoiceDate = new Date(inv.invoice_date).toLocaleDateString();
                            const dueDate = new Date(inv.due_date).toLocaleDateString();

                            let statusColor = 'bg-gray-100 text-gray-800';
                            if (inv.status === 'Pending') statusColor = 'bg-yellow-100 text-yellow-800';
                            if (inv.status === 'Paid') statusColor = 'bg-green-100 text-green-800';
                            if (inv.status === 'Overdue') statusColor = 'bg-red-100 text-red-800';

                            tr.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${inv.invoice_number}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${inv.parent?.user?.name || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${invoiceDate}</td>
                    <td class="px-6 py-4 text-sm font-bold text-gray-900">$${inv.amount}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${dueDate}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${inv.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <select onchange="window.updateInvoiceStatus('${inv.id}', this.value)" class="text-xs border rounded p-1">
                            <option value="Pending" ${inv.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Paid" ${inv.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Overdue" ${inv.status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                            <option value="Cancelled" ${inv.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                                `;
                            tbody.appendChild(tr);
                        });
                    }

                    window.updateInvoiceStatus = async (id, status) => {
                        const { updateInvoiceStatus } = await import('./db-service.js');
                        try {
                            await updateInvoiceStatus(id, status);
                            loadInvoices(); // Refresh to update colors
                        } catch (err) {
                            alert("Failed to update: " + err.message);
                        }
                    };

                    window.loadParentOptionsForInvoice = async () => {
                        const select = document.getElementById('invoice-parent-select');
                        if (!select || select.dataset.loaded) return;

                        try {
                            const { getParents } = await import('./db-service.js');
                            const parents = await getParents();

                            select.innerHTML = '<option value="">-- Select Parent --</option>';
                            parents.forEach(p => {
                                const option = document.createElement('option');
                                option.value = p.id;
                                option.textContent = `${p.name} (${p.email})`;
                                select.appendChild(option);
                            });
                            select.dataset.loaded = "true";
                        } catch (err) {
                            console.error("Error loading parents:", err);
                        }
                    };

                    // Invoice Form Handler
                    const addInvoiceForm = document.getElementById('add-invoice-form');
                    if (addInvoiceForm) {
                        initRealTimeValidation('#add-invoice-form');
                        addInvoiceForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const errorMsg = document.getElementById('invoice-error-msg');
                            clearAllErrors('#add-invoice-form');

                            const btn = addInvoiceForm.querySelector('button[type="submit"]');
                            const originalText = btn.textContent;

                            const formData = new FormData(addInvoiceForm);
                            const invoiceData = Object.fromEntries(formData.entries());

                            let hasError = false;
                            if (!toggleError('invoice-parent-select', "Please select a parent", validators.isRequired(invoiceData.parent_id))) hasError = true;
                            if (!toggleError('inv-amount', "Enter a valid amount", validators.isRequired(invoiceData.amount) && Number(invoiceData.amount) > 0)) hasError = true;
                            if (!toggleError('inv-due-date', "Due date required", validators.isRequired(invoiceData.due_date))) hasError = true;

                            if (hasError) return;

                            btn.disabled = true;
                            btn.textContent = "Generating...";

                            try {
                                const { createInvoice } = await import('./db-service.js');
                                await createInvoice(invoiceData);

                                alert("Invoice generated successfully!");
                                document.getElementById('invoice-modal').classList.add('hidden');
                                addInvoiceForm.reset();
                                loadInvoices();

                            } catch (err) {
                                errorMsg.textContent = "Error: " + err.message;
                                errorMsg.classList.add('visible');
                            } finally {
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                        });
                    }
                </script>
</body>

</html>
```