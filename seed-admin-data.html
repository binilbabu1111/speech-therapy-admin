<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seed Admin Data</title>
    <script type="module" src="supabase-fetch-client.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.5;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>Center Admin Data Seeder</h1>
    <p>This script will seed 10 students and 5 therapists for dashboard verification.</p>
    <button id="seed-btn">Run Seeder</button>
    <div id="output"></div>

    <script type="module">
        import { supabase } from './supabase-fetch-client.js';
        import { createStudent } from './db-service.js';

        const btn = document.getElementById('seed-btn');
        const output = document.getElementById('output');

        function log(msg, type = '') {
            const p = document.createElement('p');
            p.textContent = msg;
            if (type) p.className = type;
            output.appendChild(p);
        }

        btn.onclick = async () => {
            btn.disabled = true;
            output.innerHTML = 'Starting Seeding...<br>';

            try {
                // 1. Create 5 Therapists
                log("Creating 5 therapists...");
                const therapists = [
                    { email: 'sarah.therapy@example.com', name: 'Sarah Miller', role: 'therapist' },
                    { email: 'james.wilson@example.com', name: 'James Wilson', role: 'therapist' },
                    { email: 'emily.chen@example.com', name: 'Emily Chen', role: 'therapist' },
                    { email: 'michael.ross@example.com', name: 'Michael Ross', role: 'therapist' },
                    { email: 'lisa.ann@example.com', name: 'Lisa Ann', role: 'therapist' }
                ];

                for (let i = 0; i < therapists.length; i++) {
                    const t = therapists[i];
                    log(`Registering therapist: ${t.name}...`);

                    // Create in auth first
                    const { data, error: authErr } = await supabase.auth.signUp({
                        email: t.email,
                        password: 'Password123!',
                        options: { data: { full_name: t.name } }
                    });

                    if (authErr) {
                        log(`Auth error for ${t.name}: ${authErr.message}`, "error");
                        // If user already exists, we might still want to promote them
                    }

                    const user = data.user || (await supabase.from('users').select('*').eq('email', t.email).single()).data;

                    if (user) {
                        const { error: pErr } = await supabase.from('users').update({
                            role: 'therapist',
                            status: 'active'
                        }).eq('id', user.id);

                        if (pErr) log(`Error promoting ${t.name}: ${pErr.message}`, "error");
                        else log(`Therapist seeded and promoted: ${t.name}`, "success");
                    }
                }

                // 2. Create 3 Parents to distribute children
                log("Creating test parents...");
                const parentData = [
                    { email: 'parent.one@example.com', name: 'Alice Parent', id: '00000000-0000-0000-0000-000000000021' },
                    { email: 'parent.two@example.com', name: 'Bob Parent', id: '00000000-0000-0000-0000-000000000022' },
                    { email: 'parent.three@example.com', name: 'Charlie Parent', id: '00000000-0000-0000-0000-000000000023' }
                ];

                const parentIds = [];
                for (const p of parentData) {
                    log(`Registering parent: ${p.name}...`);
                    const { data, error: uErr } = await supabase.auth.signUp({
                        email: p.email,
                        password: 'Password123!',
                        options: { data: { full_name: p.name } }
                    });

                    if (uErr) {
                        log(`Auth error for parent ${p.name}: ${uErr.message}`, "error");
                    }

                    const user = data.user || (await supabase.from('users').select('*').eq('email', p.email).single()).data;

                    if (user) {
                        // Promote to parent role
                        await supabase.from('users').update({ role: 'parent' }).eq('id', user.id);

                        const { data: newParent, error: pErr } = await supabase.from('parents').upsert([{
                            user_id: user.id,
                            address: '789 Seed Ave',
                            emergency_contact: '555-9999'
                        }]).select().single();

                        if (pErr) log(`Error creating parent record ${p.name}: ${pErr.message}`, "error");
                        else {
                            log(`Parent created: ${p.name}`, "success");
                            parentIds.push(newParent.id);
                        }
                    }
                }

                // 3. Create 10 Students under these parents
                if (parentIds.length > 0) {
                    log("Creating 10 students distributed among parents...");
                    const studentNames = [
                        { f: "Liam", l: "One" }, { f: "Noah", l: "One" },
                        { f: "Emma", l: "Two" }, { f: "Olivia", l: "Two" }, { f: "Ava", l: "Two" },
                        { f: "Elijah", l: "Three" }, { f: "Lucas", l: "Three" }, { f: "Mason", l: "Three" }, { f: "Sophia", l: "Three" }, { f: "Isabella", l: "Three" }
                    ];

                    for (let i = 0; i < studentNames.length; i++) {
                        const name = studentNames[i];
                        const parentId = parentIds[i % parentIds.length]; // Distribute
                        const student = {
                            first_name: name.f,
                            last_name: name.l,
                            dob: `201${5 + (i % 5)}-01-01`,
                            grade: i < 5 ? "Kindergarten" : "1st",
                            diagnosis: i % 2 === 0 ? "Speech Delay" : "Social Anxiety",
                            parent_id: parentId,
                            therapy_status: i % 3 === 0 ? "Active" : "Evaluation"
                        };
                        try {
                            await createStudent(student);
                            log(`Student added: ${name.f} ${name.l}`, "success");
                        } catch (e) {
                            log(`Error adding student ${name.f}: ${e.message}`, "error");
                        }
                    }
                }

                log("Seeding process completed.", "success");
            } catch (err) {
                log("Fatal error: " + err.message, "error");
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>